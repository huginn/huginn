#!/bin/bash
# This deploy hook gets executed after dependencies are resolved and the
# build hook has been run but before the application has been started back
# up again.  This script gets executed directly, so it could be python, php,
# ruby, etc.

echo "-> Deploy step"

pushd ${OPENSHIFT_REPO_DIR} > /dev/null

STORED_ASSETS="${OPENSHIFT_DATA_DIR}/assets"
LIVE_ASSETS="${OPENSHIFT_REPO_DIR}/public/assets"

# Ensure our stored assets directory exists
if [ ! -d "${STORED_ASSETS}" ]; then
  echo "  Creating permanent assets directory"
  mkdir "${STORED_ASSETS}"
fi

# Create symlink to stored assets unless we're uploading our own assets
if [ -d "${LIVE_ASSETS}" ]; then
  echo "  WARNING: Assets included in git repository, not using stored assets"
else
  echo "  Restoring stored assets"
  \ln -sf "${STORED_ASSETS}" "${LIVE_ASSETS}"
fi

source ${OPENSHIFT_REPO_DIR}/.env

mkdir -p log tmp/pids tmp/sockets

echo "jobs: bundle exec rails runner bin/threaded.rb" > Procfile

\sed -r -i -e "s@^ *set :deploy_to.+@set :deploy_to, '${OPENSHIFT_REPO_DIR}'@" config/deploy.rb

echo "Migrating"
bundle exec rake db:migrate RAILS_ENV=production

popd > /dev/null
